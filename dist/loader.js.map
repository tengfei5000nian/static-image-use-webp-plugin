{"version":3,"file":"loader.js","names":["isCommonExport","data","test","isES6Export","isExportModule","extensionRegExp","includeExtensions","RegExp","join","getExportName","module","assets","Object","keys","buildInfo","name","find","asset","indexOf","getImageContent","loaderContext","content","toString","query","currentModule","source","createWebpContent","imageContent","imageminWebp","imageminWebpOptions","createPublicPath","sourceMap","fileLoaderContext","assign","fileLoaderOptions","fileLoader","call","setWebpToggle","webpContent","exportPath","otherImageName","extRE","webpImageName","replace","res","ext","emitFile","assetsInfo","get","forceMinSize","delete","isSupportWebp","isSupportWebpModule","concat","raw","map","meta","callback","async","image","webp","length","path","err"],"sources":["../src/loader.js"],"sourcesContent":["import imageminWebp from 'imagemin-webp'\nimport fileLoader from 'file-loader'\n\n/**\n * @param {String} data content.toString()的值\n * @return {Boolean} 是否是CommonJs导出模块\n*/\nfunction isCommonExport(data) {\n  return /module\\.exports/.test(data)\n}\n\n/**\n * @param {String} data content.toString()的值\n * @return {Boolean} 是否是ES6导出模块\n*/\nfunction isES6Export(data) {\n  return /export\\sdefault/.test(data)\n}\n\n/**\n * @param {String} data content.toString()的值\n * @return {Boolean} 是否是导出模块\n*/\nfunction isExportModule(data) {\n  return isCommonExport(data) || isES6Export(data)\n}\n\n/**\n * @param {Array} includeExtensions 要求生成webp的图片扩展名数组\n * @return {RegExp} 图片扩展名正则\n*/\nfunction extensionRegExp(includeExtensions) {\n  return new RegExp(`\\\\.(${includeExtensions.join('|')})($|\\\\\"|\\\\'|\\\\?)`, 'g')\n}\n\n/**\n * @param {NormalModule} module 当前模块\n * @param {String} data content.toString()的值\n * @return {String} 之前loader emitFile文件的name\n*/\nfunction getExportName(module, data) {\n  const assets = Object.keys(module.buildInfo.assets)\n  const name = assets.find(asset => ~data.indexOf(asset))\n  return name\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} content loader第一个参数content\n * @return {Buffer} 返回导出文件的content buffer\n*/\nfunction getImageContent(loaderContext, content) {\n  const data = content.toString()\n  if (isExportModule(data)) {\n    if (!extensionRegExp(loaderContext.query.includeExtensions).test(data)) return null\n    const name = getExportName(loaderContext.currentModule, data)\n    return name ? loaderContext.currentModule.buildInfo.assets[name]?.source() : null\n  } else {\n    return content\n  }\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} imageContent 其它图片buffer\n * @return {Buffer} 返回webp图片buffer\n*/\nasync function createWebpContent(loaderContext, imageContent) {\n  return await imageminWebp(loaderContext.query.imageminWebpOptions || {})(imageContent)\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} content loader第一个参数content\n * @param {Object} sourceMap loader第一个参数content\n * @return {String} 导出模块文件路径\n*/\nfunction createPublicPath(loaderContext, content, sourceMap) {\n  const data = content.toString()\n  if (isExportModule(data)) {\n    return data\n  } else {\n    const fileLoaderContext = Object.assign({}, loaderContext, {\n      query: loaderContext.query.fileLoaderOptions || {}\n    })\n    return fileLoader.call(fileLoaderContext, content, sourceMap)\n  }\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} webpContent webp图片buffer\n * @param {String} exportPath 导出模块文件路径\n * @param {Object} sourceMap loader第一个参数content\n * @return {String} 导出模块文件路径\n*/\nfunction setWebpToggle(loaderContext, webpContent, exportPath, sourceMap) {\n  const otherImageName = getExportName(loaderContext.currentModule, exportPath)\n  const extRE = extensionRegExp(loaderContext.query.includeExtensions)\n  const webpImageName = otherImageName.replace(\n    extRE,\n    (res, ext) => res.replace(ext, 'webp')\n  )\n\n  loaderContext.emitFile(\n    webpImageName,\n    webpContent,\n    sourceMap,\n    loaderContext.currentModule.buildInfo.assetsInfo?.get(otherImageName)\n  )\n\n  if (loaderContext.query.forceMinSize === true) {\n    delete loaderContext.currentModule.buildInfo.assets[otherImageName]\n    loaderContext.currentModule.buildInfo.assetsInfo.delete(otherImageName)\n    return exportPath.replace(\n      extRE,\n      (res, ext) => res.replace(ext, 'webp')\n    )\n  } else {\n    let isSupportWebp = ''\n    if (isCommonExport(exportPath)) {\n      isSupportWebp = `const isSupportWebp = require(\"${loaderContext.query.isSupportWebpModule}\").default;\\n`\n    } else if (isES6Export(exportPath)) {\n      isSupportWebp = `import isSupportWebp from \"${loaderContext.query.isSupportWebpModule}\";\\n`\n    }\n\n    return isSupportWebp.concat(exportPath.replace(\n      extRE,\n      (res, ext) => res.replace(\n        ext,\n        `\" + (isSupportWebp === true ? \"webp\" : \"${ext}\") + \"`\n      )\n    ))\n  }\n}\n\nexport const raw = true\n\nexport default async function (content, map, meta) {\n  const callback = this.async()\n  try {\n    const image = getImageContent(this, content)\n    if (!image) {\n      callback(null, content, map, meta)\n      return\n    }\n\n    const webp = await createWebpContent(this, image)\n    if (image.length <= webp.length) {\n      callback(null, content, map, meta)\n      return\n    }\n\n    const path = setWebpToggle(\n      this,\n      webp,\n      createPublicPath(this, content, map),\n      map\n    )\n\n    callback(null, path, map, meta)\n  } catch (err) {\n    callback(err, '', map, meta)\n  }\n}\n"],"mappings":"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"}