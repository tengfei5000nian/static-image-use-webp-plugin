{"version":3,"file":"static-image-use-webp-loader.js","names":["isExportPath","data","test","extensionRegExp","includeExtensions","RegExp","join","getExportName","module","assets","Object","keys","buildInfo","name","find","asset","indexOf","getImageContent","loaderContext","content","toString","query","currentModule","source","createWebpContent","imageContent","imageminWebp","imageminWebpOptions","createPublicPath","sourceMap","fileLoaderContext","assign","getOptions","fileLoaderOptions","fileLoader","call","setWebpToggle","webpContent","exportPath","otherImageName","extRE","webpImageName","replace","res","ext","emitFile","assetsInfo","get","raw","map","meta","callback","async","image","webp","length","path","err"],"sources":["../src/static-image-use-webp-loader.js"],"sourcesContent":["import imageminWebp from 'imagemin-webp'\nimport fileLoader from 'file-loader'\n\n/**\n * @param {String} data content.toString()的值\n * @return {Boolean} 是否是导出模块文件路径\n*/\nfunction isExportPath(data) {\n  return /export\\sdefault|module\\.exports/.test(data)\n}\n\n/**\n * @param {Array} includeExtensions 要求生成webp的图片扩展名数组\n * @return {RegExp} 图片扩展名正则\n*/\nfunction extensionRegExp(includeExtensions) {\n  return new RegExp(`\\\\.(${includeExtensions.join('|')})($|\\\\\"|\\\\'|\\\\?)`, 'g')\n}\n\n/**\n * @param {NormalModule} module 当前模块\n * @param {String} data content.toString()的值\n * @return {String} 之前loader emitFile文件的name\n*/\nfunction getExportName(module, data) {\n  const assets = Object.keys(module.buildInfo.assets)\n  const name = assets.find(asset => ~data.indexOf(asset))\n  return name\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} content loader第一个参数content\n * @return {Buffer} 返回导出文件的content buffer\n*/\nfunction getImageContent(loaderContext, content) {\n  const data = content.toString()\n  if (isExportPath(data)) {\n    if (!extensionRegExp(loaderContext.query.includeExtensions).test(data)) return null\n    const name = getExportName(loaderContext.currentModule, data)\n    return name ? loaderContext.currentModule.buildInfo.assets[name]?.source() : null\n  } else {\n    return content\n  }\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} imageContent 其它图片buffer\n * @return {Buffer} 返回webp图片buffer\n*/\nasync function createWebpContent(loaderContext, imageContent) {\n  return await imageminWebp(loaderContext.query.imageminWebpOptions || {})(imageContent)\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} content loader第一个参数content\n * @param {Object} sourceMap loader第一个参数content\n * @return {String} 导出模块文件路径\n*/\nfunction createPublicPath(loaderContext, content, sourceMap) {\n  const data = content.toString()\n  if (isExportPath(data)) {\n    return data\n  } else {\n    const fileLoaderContext = Object.assign({}, loaderContext, {\n      getOptions: () => loaderContext.getOptions(loaderContext)?.fileLoaderOptions || {}\n    })\n    return fileLoader.call(fileLoaderContext, content, sourceMap)\n  }\n}\n\n/**\n * @param {Object} loaderContext 当前loader的this\n * @param {Buffer} webpContent webp图片buffer\n * @param {String} exportPath 导出模块文件路径\n * @param {Object} sourceMap loader第一个参数content\n * @return {String} 导出模块文件路径\n*/\nfunction setWebpToggle(loaderContext, webpContent, exportPath, sourceMap) {\n  const otherImageName = getExportName(loaderContext.currentModule, exportPath)\n  const extRE = extensionRegExp(loaderContext.query.includeExtensions)\n  const webpImageName = otherImageName.replace(\n    extRE,\n    (res, ext) => res.replace(ext, 'webp')\n  )\n  loaderContext.emitFile(\n    webpImageName,\n    webpContent,\n    sourceMap,\n    loaderContext.currentModule.buildInfo.assetsInfo?.get(otherImageName)\n  )\n  return exportPath.replace(\n    extRE,\n    (res, ext) => res.replace(\n      ext,\n      `\" + (global.isSupportWebp === true ? \"webp\" : \"${ext}\") + \"`\n    )\n  )\n}\n\nexport const raw = true\n\nexport default async function (content, map, meta) {\n  const callback = this.async()\n  try {\n    const image = getImageContent(this, content)\n    if (!image) {\n      callback(null, content, map, meta)\n      return\n    }\n\n    const webp = await createWebpContent(this, image)\n    if (image.length <= webp.length) {\n      callback(null, content, map, meta)\n      return\n    }\n\n    const path = setWebpToggle(\n      this,\n      webp,\n      createPublicPath(this, content, map),\n      map\n    )\n\n    callback(null, path, map, meta)\n  } catch (err) {\n    callback(err, '', map, meta)\n  }\n}\n"],"mappings":"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"}