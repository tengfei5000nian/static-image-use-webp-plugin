{"version":3,"file":"static-image-use-webp-plugin.js","names":["pluginName","StaticImageUseWebpPlugin","constructor","options","Object","assign","isSupportWebpPath","path","join","__dirname","includeExtensions","validate","defaultOptions","apply","compiler","setVerifyIsSupportWebp","setExtensionToggle","hooks","entryOption","tap","_","entry","name","keys","import","unshift","Error","isWebpackV5","webpack","version","loader","test","RegExp","thisCompilation","compilation","tapCallback","loaderContext","module","userRequest","defineProperty","get","loaders","NormalModule","getCompilationHooks","normalModuleLoader"],"sources":["../src/static-image-use-webp-plugin.js"],"sourcesContent":["import path from 'path'\nimport { validate } from 'schema-utils'\nimport { NormalModule } from 'webpack'\n\nimport defaultOptions from './options.json'\n\nconst pluginName = 'static-image-use-webp-plugin'\n\nexport default class StaticImageUseWebpPlugin {\n  constructor(options = {}) {\n    this.options = Object.assign({\n      isSupportWebpPath: path.join(__dirname, 'is-support-webp.js'),\n      includeExtensions: ['png', 'jpg', 'jpeg']\n    }, options)\n\n    validate(defaultOptions, this.options)\n  }\n\n  apply(compiler) {\n    this.setVerifyIsSupportWebp(compiler)\n    this.setExtensionToggle(compiler)\n  }\n\n  setVerifyIsSupportWebp(compiler) {\n    compiler.hooks.entryOption.tap(pluginName, (_, entry) => {\n      if (typeof entry !== 'function') {\n        for (const name of Object.keys(entry)) {\n          entry[name].import?.unshift(this.options.isSupportWebpPath)\n        }\n      } else {\n        throw new Error(\n          `${pluginName} doesn't support dynamic entry (function) yet`\n        );\n      }\n    })\n  }\n\n  setExtensionToggle(compiler) {\n    const isWebpackV5 = compiler.webpack && compiler.webpack.version >= '5'\n    const loader = path.join(__dirname, 'static-image-use-webp-loader.js')\n    const test = new RegExp(`\\\\.(${this.options.includeExtensions.join('|')})($|\\\\\"|\\\\'|\\\\?)`)\n\n    compiler.hooks.thisCompilation.tap(pluginName, compilation => {\n\n      const tapCallback = (loaderContext, module) => {\n        if (!test.test(module.userRequest)) return\n\n        Object.defineProperty(loaderContext, 'currentModule', {\n          get: () => module\n        })\n\n        module.loaders.unshift({\n          loader,\n          options: this.options\n        })\n      }\n\n      if (isWebpackV5) {\n        NormalModule.getCompilationHooks(compilation).loader.tap(\n          pluginName,\n          tapCallback\n        )\n      } else {\n        compilation.hooks.normalModuleLoader.tap(pluginName, tapCallback)\n      }\n    })\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AAEA;;;;AAEA,MAAMA,UAAU,GAAG,8BAAnB;;AAEe,MAAMC,wBAAN,CAA+B;EAC5CC,WAAW,CAACC,OAAO,GAAG,EAAX,EAAe;IACxB,KAAKA,OAAL,GAAeC,MAAM,CAACC,MAAP,CAAc;MAC3BC,iBAAiB,EAAEC,aAAA,CAAKC,IAAL,CAAUC,SAAV,EAAqB,oBAArB,CADQ;MAE3BC,iBAAiB,EAAE,CAAC,KAAD,EAAQ,KAAR,EAAe,MAAf;IAFQ,CAAd,EAGZP,OAHY,CAAf;IAKA,IAAAQ,qBAAA,EAASC,gBAAT,EAAyB,KAAKT,OAA9B;EACD;;EAEDU,KAAK,CAACC,QAAD,EAAW;IACd,KAAKC,sBAAL,CAA4BD,QAA5B;IACA,KAAKE,kBAAL,CAAwBF,QAAxB;EACD;;EAEDC,sBAAsB,CAACD,QAAD,EAAW;IAC/BA,QAAQ,CAACG,KAAT,CAAeC,WAAf,CAA2BC,GAA3B,CAA+BnB,UAA/B,EAA2C,CAACoB,CAAD,EAAIC,KAAJ,KAAc;MACvD,IAAI,OAAOA,KAAP,KAAiB,UAArB,EAAiC;QAC/B,KAAK,MAAMC,IAAX,IAAmBlB,MAAM,CAACmB,IAAP,CAAYF,KAAZ,CAAnB,EAAuC;UAAA;;UACrC,sBAAAA,KAAK,CAACC,IAAD,CAAL,CAAYE,MAAZ,0EAAoBC,OAApB,CAA4B,KAAKtB,OAAL,CAAaG,iBAAzC;QACD;MACF,CAJD,MAIO;QACL,MAAM,IAAIoB,KAAJ,CACH,GAAE1B,UAAW,+CADV,CAAN;MAGD;IACF,CAVD;EAWD;;EAEDgB,kBAAkB,CAACF,QAAD,EAAW;IAC3B,MAAMa,WAAW,GAAGb,QAAQ,CAACc,OAAT,IAAoBd,QAAQ,CAACc,OAAT,CAAiBC,OAAjB,IAA4B,GAApE;;IACA,MAAMC,MAAM,GAAGvB,aAAA,CAAKC,IAAL,CAAUC,SAAV,EAAqB,iCAArB,CAAf;;IACA,MAAMsB,IAAI,GAAG,IAAIC,MAAJ,CAAY,OAAM,KAAK7B,OAAL,CAAaO,iBAAb,CAA+BF,IAA/B,CAAoC,GAApC,CAAyC,kBAA3D,CAAb;IAEAM,QAAQ,CAACG,KAAT,CAAegB,eAAf,CAA+Bd,GAA/B,CAAmCnB,UAAnC,EAA+CkC,WAAW,IAAI;MAE5D,MAAMC,WAAW,GAAG,CAACC,aAAD,EAAgBC,MAAhB,KAA2B;QAC7C,IAAI,CAACN,IAAI,CAACA,IAAL,CAAUM,MAAM,CAACC,WAAjB,CAAL,EAAoC;QAEpClC,MAAM,CAACmC,cAAP,CAAsBH,aAAtB,EAAqC,eAArC,EAAsD;UACpDI,GAAG,EAAE,MAAMH;QADyC,CAAtD;QAIAA,MAAM,CAACI,OAAP,CAAehB,OAAf,CAAuB;UACrBK,MADqB;UAErB3B,OAAO,EAAE,KAAKA;QAFO,CAAvB;MAID,CAXD;;MAaA,IAAIwB,WAAJ,EAAiB;QACfe,qBAAA,CAAaC,mBAAb,CAAiCT,WAAjC,EAA8CJ,MAA9C,CAAqDX,GAArD,CACEnB,UADF,EAEEmC,WAFF;MAID,CALD,MAKO;QACLD,WAAW,CAACjB,KAAZ,CAAkB2B,kBAAlB,CAAqCzB,GAArC,CAAyCnB,UAAzC,EAAqDmC,WAArD;MACD;IACF,CAvBD;EAwBD;;AA1D2C"}