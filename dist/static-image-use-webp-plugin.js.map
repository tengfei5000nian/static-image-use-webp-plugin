{"version":3,"file":"static-image-use-webp-plugin.js","names":["pluginName","StaticImageUseWebpPlugin","constructor","options","Object","assign","isSupportWebpPath","path","join","__dirname","includeExtensions","validate","defaultOptions","apply","compiler","setVerifyIsSupportWebp","setExtensionToggle","hooks","entryOption","tap","_","entry","name","keys","import","unshift","Error","loader","test","RegExp","thisCompilation","compilation","NormalModule","getCompilationHooks","loaderContext","module","userRequest","defineProperty","get","loaders"],"sources":["../src/static-image-use-webp-plugin.js"],"sourcesContent":["import path from 'path'\nimport { validate } from 'schema-utils'\nimport { NormalModule } from 'webpack'\n\nimport defaultOptions from './options.json'\n\nconst pluginName = 'static-image-use-webp-plugin'\n\nexport default class StaticImageUseWebpPlugin {\n  constructor(options = {}) {\n    this.options = Object.assign({\n      isSupportWebpPath: path.join(__dirname, 'is-support-webp.js'),\n      includeExtensions: ['png', 'jpg', 'jpeg']\n    }, options)\n\n    validate(defaultOptions, this.options)\n  }\n\n  apply(compiler) {\n    this.setVerifyIsSupportWebp(compiler)\n    this.setExtensionToggle(compiler)\n  }\n\n  setVerifyIsSupportWebp(compiler) {\n    compiler.hooks.entryOption.tap(pluginName, (_, entry) => {\n      if (typeof entry !== 'function') {\n        for (const name of Object.keys(entry)) {\n          entry[name].import?.unshift(this.options.isSupportWebpPath)\n        }\n      } else {\n        throw new Error(\n          `${pluginName} doesn't support dynamic entry (function) yet`\n        );\n      }\n    })\n  }\n\n  setExtensionToggle(compiler) {\n    const loader = path.join(__dirname, 'static-image-use-webp-loader.js')\n    const test = new RegExp(`\\\\.(${this.options.includeExtensions.join('|')})($|\\\\\"|\\\\'|\\\\?)`)\n\n    compiler.hooks.thisCompilation.tap(pluginName, compilation => {\n      const hooks = NormalModule.getCompilationHooks(compilation)\n      hooks.loader.tap(pluginName, (loaderContext, module) => {\n        if (!test.test(module.userRequest)) return\n\n        Object.defineProperty(loaderContext, 'currentModule', {\n          get: () => module\n        })\n\n        module.loaders.unshift({\n          loader,\n          options: this.options\n        })\n      })\n    })\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AAEA;;;;AAEA,MAAMA,UAAU,GAAG,8BAAnB;;AAEe,MAAMC,wBAAN,CAA+B;EAC5CC,WAAW,CAACC,OAAO,GAAG,EAAX,EAAe;IACxB,KAAKA,OAAL,GAAeC,MAAM,CAACC,MAAP,CAAc;MAC3BC,iBAAiB,EAAEC,aAAA,CAAKC,IAAL,CAAUC,SAAV,EAAqB,oBAArB,CADQ;MAE3BC,iBAAiB,EAAE,CAAC,KAAD,EAAQ,KAAR,EAAe,MAAf;IAFQ,CAAd,EAGZP,OAHY,CAAf;IAKA,IAAAQ,qBAAA,EAASC,gBAAT,EAAyB,KAAKT,OAA9B;EACD;;EAEDU,KAAK,CAACC,QAAD,EAAW;IACd,KAAKC,sBAAL,CAA4BD,QAA5B;IACA,KAAKE,kBAAL,CAAwBF,QAAxB;EACD;;EAEDC,sBAAsB,CAACD,QAAD,EAAW;IAC/BA,QAAQ,CAACG,KAAT,CAAeC,WAAf,CAA2BC,GAA3B,CAA+BnB,UAA/B,EAA2C,CAACoB,CAAD,EAAIC,KAAJ,KAAc;MACvD,IAAI,OAAOA,KAAP,KAAiB,UAArB,EAAiC;QAC/B,KAAK,MAAMC,IAAX,IAAmBlB,MAAM,CAACmB,IAAP,CAAYF,KAAZ,CAAnB,EAAuC;UAAA;;UACrC,sBAAAA,KAAK,CAACC,IAAD,CAAL,CAAYE,MAAZ,0EAAoBC,OAApB,CAA4B,KAAKtB,OAAL,CAAaG,iBAAzC;QACD;MACF,CAJD,MAIO;QACL,MAAM,IAAIoB,KAAJ,CACH,GAAE1B,UAAW,+CADV,CAAN;MAGD;IACF,CAVD;EAWD;;EAEDgB,kBAAkB,CAACF,QAAD,EAAW;IAC3B,MAAMa,MAAM,GAAGpB,aAAA,CAAKC,IAAL,CAAUC,SAAV,EAAqB,iCAArB,CAAf;;IACA,MAAMmB,IAAI,GAAG,IAAIC,MAAJ,CAAY,OAAM,KAAK1B,OAAL,CAAaO,iBAAb,CAA+BF,IAA/B,CAAoC,GAApC,CAAyC,kBAA3D,CAAb;IAEAM,QAAQ,CAACG,KAAT,CAAea,eAAf,CAA+BX,GAA/B,CAAmCnB,UAAnC,EAA+C+B,WAAW,IAAI;MAC5D,MAAMd,KAAK,GAAGe,qBAAA,CAAaC,mBAAb,CAAiCF,WAAjC,CAAd;;MACAd,KAAK,CAACU,MAAN,CAAaR,GAAb,CAAiBnB,UAAjB,EAA6B,CAACkC,aAAD,EAAgBC,MAAhB,KAA2B;QACtD,IAAI,CAACP,IAAI,CAACA,IAAL,CAAUO,MAAM,CAACC,WAAjB,CAAL,EAAoC;QAEpChC,MAAM,CAACiC,cAAP,CAAsBH,aAAtB,EAAqC,eAArC,EAAsD;UACpDI,GAAG,EAAE,MAAMH;QADyC,CAAtD;QAIAA,MAAM,CAACI,OAAP,CAAed,OAAf,CAAuB;UACrBE,MADqB;UAErBxB,OAAO,EAAE,KAAKA;QAFO,CAAvB;MAID,CAXD;IAYD,CAdD;EAeD;;AAhD2C"}